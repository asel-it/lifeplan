<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Task Progress Tracker</title>
    <link rel="stylesheet" href="css/task-tracker.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script type="module" src="js/save.js"></script>
    <style>
        /* Общие стили */
        body {
            font-family: Arial, sans-serif;
            background-color: #f9f9f9;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
        }

        /* Контейнер для задачи */
        .container {
            background-color: #fff;
            border-radius: 15px; /* Закругленные углы */
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            width: 60%; /* Ширина 60% */
        }

        /* Стили для форм */
        .task-form, .stage-form {
            margin-bottom: 20px;
        }

        /* Поля ввода */
        input[type="text"],
        input[type="date"],
        select {
            border-radius: 10px; /* Закругленные углы */
            border: 1px solid #ccc;
            padding: 10px;
            width: calc(100% - 22px); /* Учитываем padding и border */
            background-color: #f9f9f9; /* Светлый фон */
            box-sizing: border-box;
            margin-bottom: 10px;
        }

        /* Кнопки */
        button {
            border-radius: 10px; /* Закругленные углы */
            border: none;
            background-color: #007bff; /* Цвет кнопки */
            color: white;
            padding: 10px 15px;
            cursor: pointer;
            transition: background-color 0.3s;
            width: 100%; /* Занимает всю ширину */
        }
        button:hover {
            background-color: #0056b3; /* Цвет при наведении */
        }

        /* Стили для таблицы */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ccc;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
        }

        /* Прогресс-бар */
        /* Стили для контейнера прогресс-бара */
        .progress-container {
            width: 100%; /* Ширина контейнера */
            background-color: #e0e0e0; /* Цвет фона контейнера */
            border-radius: 5px; /* Скругление углов */
            margin: 5px 0; /* Отступ сверху и снизу */
            height: 20px; /* Высота прогресс-бара */
        }

        /* Стили для самого прогресс-бара */
        .progress-bar {
            height: 100%; /* Высота прогресс-бара равна высоте контейнера */
            background-color: #9db8b5; /* Цвет прогресс-бара */
            border-radius: 5px; /* Скругление углов */
            transition: width 0.5s ease; /* Плавный переход при изменении ширины */
        }

        /* Кнопки */
        .button-group {
            display: flex;
            gap: 10px; /* Отступ между кнопками */
        }
        .stage-buttons {
            display: flex;
            gap: 5px; /* Пробел между кнопками */
        }
        .stage-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px; /* Отступ между элементами списка этапов */
        }
    </style>
</head>
<body>
<div class="container">
    <h1 style="text-align: center;">Task Progress Tracker</h1>
    <div class="task-form">
        <h2>Add a Task</h2>
        <input type="text" id="taskName" placeholder="Task Name" required>
        <input type="date" id="taskDeadline" placeholder="Set a deadline date" required>
        <button id="addTaskButton">Add Task</button>
    </div>
    <div class="stage-form" id="stageForm" style="display: none;">
        <h2>Add Task Stages</h2>
        <input type="text" id="stageName" placeholder="Stage Name" required>
        <select id="effortLevel">
            <option value="1">Easy</option>
            <option value="2">Moderately Easy</option>
            <option value="3">Challenging</option>
            <option value="4">Hard</option>
            <option value="5">Very Hard</option>
        </select>
        <div class="stage-buttons">
            <button id="addStageButton">Add Stage</button>
            <button id="saveStageButton" style="display:none;">Save Stage</button>
        </div>
        <div id="stageList"></div> <!-- Список этапов -->
    </div>
    <table id="taskTable" border="1">
        <thead>
            <tr>
                <th>Task</th>
                <th>Deadline</th>
                <th>Progress</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="taskTableBody">
            <!-- Здесь будут отображаться задачи -->
        </tbody>
    </table>
</div>

<!-- Подключение Flatpickr и скриптов -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const addTaskButton = document.getElementById('addTaskButton');
        const taskNameInput = document.getElementById('taskName');
        const taskDeadlineInput = document.getElementById('taskDeadline');
        const addStageButton = document.getElementById('addStageButton');
        const stageForm = document.getElementById('stageForm');
        const taskTableBody = document.getElementById('taskTableBody');

        let tasks = JSON.parse(localStorage.getItem('tasks')) || [];
        let currentTask = null;
        let editingStageIndex = null; // Индекс редактируемого этапа

        const effortWeights = {
            1: 1,
            2: 2,
            3: 3,
            4: 4,
            5: 5
        };

        function saveTasksToLocalStorage() {
            localStorage.setItem('tasks', JSON.stringify(tasks));
        }

        addTaskButton.addEventListener('click', (event) => {
            event.preventDefault();
            const taskName = taskNameInput.value.trim();
            const taskDeadline = taskDeadlineInput.value;

            if (taskName && taskDeadline) {
                const task = {
                    name: taskName,
                    deadline: taskDeadline,
                    stages: [],
                    totalWeight: 0,
                    completedWeight: 0,
                    progress: 0,
                    stagesVisible: false
                };
                tasks.push(task);
                currentTask = task;
                stageForm.style.display = 'block';
                updateTaskTable();
                saveTasksToLocalStorage();
            } else {
                alert('Please enter a task name and deadline!');
            }
        });

        addStageButton.addEventListener('click', (event) => {
            event.preventDefault();
            const stageName = document.getElementById('stageName').value.trim();
            const effortLevel = parseInt(document.getElementById('effortLevel').value);

            if (stageName && effortLevel && currentTask) {
                const stageWeight = effortWeights[effortLevel];
                if (editingStageIndex !== null) {
                    // Если мы редактируем этап, обновляем его
                    currentTask.stages[editingStageIndex] = { name: stageName, weight: stageWeight, completed: false };
                    editingStageIndex = null; // Сбрасываем индекс редактирования
                } else {
                    // Если новый этап, добавляем его
                    currentTask.stages.push({ name: stageName, weight: stageWeight, completed: false });
                }
                recalculateStageWeights(currentTask);
                updateTaskTable();
                document.getElementById('stageName').value = '';
                document.getElementById('effortLevel').value = '1';
                displayStages(tasks.indexOf(currentTask));
                saveTasksToLocalStorage();
            } else {
                alert('Please fill in all fields!');
            }
        });

        function recalculateStageWeights(task) {
            let totalWeight = task.stages.reduce((total, stage) => total + stage.weight, 0);
            task.totalWeight = totalWeight;
            task.completedWeight = task.stages.reduce((total, stage) => total + (stage.completed ? stage.weight : 0), 0);
            task.progress = (task.totalWeight > 0) ? (task.completedWeight / task.totalWeight) * 100 : 0;
        }

        function displayStages(taskIndex) {
            const stageList = document.getElementById('stageList');
            stageList.innerHTML = '';

            currentTask.stages.forEach((stage, index) => {
                const stageItem = document.createElement('div');
                stageItem.classList.add('stage-item');
                stageItem.innerHTML = `
                    <span>${stage.name} - ${stageWeightLabel(stage.weight)} (${stage.completed ? 'Completed' : 'Not Completed'})</span>
                    <div class="stage-buttons">
                        <button onclick="toggleStageCompletion(${taskIndex}, ${index})">Toggle Completion</button>
                        <button onclick="editStage(${taskIndex}, ${index})">Edit</button>
                        <button onclick="removeStage(${taskIndex}, ${index})">Remove</button>
                    </div>
                `;
                stageList.appendChild(stageItem);
            });
        }

        function toggleStageCompletion(taskIndex, stageIndex) {
            const stage = tasks[taskIndex].stages[stageIndex];
            stage.completed = !stage.completed;
            recalculateStageWeights(tasks[taskIndex]);
            updateTaskTable();
            saveTasksToLocalStorage();
        }

        function editStage(taskIndex, stageIndex) {
            const stage = tasks[taskIndex].stages[stageIndex];
            document.getElementById('stageName').value = stage.name;
            document.getElementById('effortLevel').value = stage.weight;
            editingStageIndex = stageIndex;
        }

        function removeStage(taskIndex, stageIndex) {
            tasks[taskIndex].stages.splice(stageIndex, 1);
            recalculateStageWeights(tasks[taskIndex]);
            updateTaskTable();
            saveTasksToLocalStorage();
        }

        function updateTaskTable() {
            taskTableBody.innerHTML = '';

            tasks.forEach((task, taskIndex) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${task.name}</td>
                    <td>${task.deadline}</td>
                    <td>
                        <div class="progress-container">
                            <div class="progress-bar" style="width: ${task.progress}%;"></div>
                        </div>
                        ${task.progress.toFixed(2)}%
                    </td>
                    <td>
                        <button onclick="toggleTaskStagesVisibility(${taskIndex})">Show/Hide Stages</button>
                    </td>
                `;
                taskTableBody.appendChild(row);

                if (task.stagesVisible) {
                    displayStages(taskIndex);
                }
            });
        }

        function toggleTaskStagesVisibility(taskIndex) {
            const task = tasks[taskIndex];
            task.stagesVisible = !task.stagesVisible;
            updateTaskTable();
        }

        function stageWeightLabel(weight) {
            switch (weight) {
                case 1: return "Easy";
                case 2: return "Moderately Easy";
                case 3: return "Challenging";
                case 4: return "Hard";
                case 5: return "Very Hard";
                default: return "Unknown";
            }
        }

        updateTaskTable();
    });
</script>
</body>
</html>

